
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="http://chatbuilder.hackreactor.com/ChatBuilder.js"></script>
<link rel="stylesheet" type="text/css" href="http://darinasakura.com/chatbuilder/style/W.custom.css.pagespeed.cf.ISLsX7wtT4.css">
</head>
<body>
<div class="container">
<h2>UnBroken Chat</h2>
<h6>by:Darin Asakura</h6>
<ul class="messages"></ul>
<input class="draft" type="text"/> <button class="send">send</button>
<h6>for fun pass the chat a " :) "</h6>
<h7>p.s. current version only tested in Chrome browser.</h7>
<script>delete Chat.display;
delete Chat.fetch;
delete Chat.send;
var last_update_time;
var current_time;
var user_name = document.URL.match(/username=(.*)/)[1];
var ajaxGet = {
    url: 'https://api.parse.com/1/classes/chats',
    type: 'GET',
    data: 'order=-createdAt'
};

function chatDisplay(object) {
    object.filter(function(item) {
        prependListItem(item);
    });
    last_update_time = object[0].createdAt;
}

function chatFetch(callback) {
    $.ajax(ajaxGet).done(function(serverData) {
        var serverString = serverData.results;
        callback(serverString);
    });
}

function chatSend(sendString) {
    var chatString = user_name + ": " + sendString;
    $.ajax({
        url: 'https://api.parse.com/1/classes/chats',
        type: 'POST',
        data: JSON.stringify({
            text: chatString,
            username: user_name
        })
    });
}

function refreshChat(passed_obj) {
    $('.messages li:first').remove();
    appendListItem(passed_obj);
    last_update_time = current_time;
}

function refreshMsg(object) {
    current_time = object[0].createdAt;
    if (current_time != last_update_time) {
        refreshChat(object[0]);
    };
}

function user_li_style(obj) {
    var dynamicClass;
    var txtUser = obj.text.match(/[^:]*/i)[0];
    if (txtUser == user_name) {
        dynamicClass = "myTxt";
    } else {
        dynamicClass = "otherTxt";
    } return dynamicClass;
}
function appendListItem(obj) {
    $('.messages').append('<li><div class="' + user_li_style(obj) + '">' + chatTextFilter(obj) + ' (' + obj.createdAt + ')</div></li>');
}

function prependListItem(obj) {
    $('.messages').prepend('<li><div class="' + user_li_style(obj) + '">' + chatTextFilter(obj) + ' (' + obj.createdAt + ')</div></li>');
}

function chatTextFilter(obj) {
    var smile = "<img src='img/smile.png' alt=':)'>";
    var myRegEx = /:\)/g;
    return userIdentify(obj).replace(myRegEx, smile);
}

function userIdentify(displayText) {
    var replace_text = "<span class='myName'>" + user_name + "</span>";
    return displayText.text.replace(user_name, replace_text);
}

chatFetch(chatDisplay);
setInterval(function() {
    chatFetch(refreshMsg)
}, 2000);

$(document).ready(function() {
    $('button.send').on('click', function() {
        chatSend($('.draft').val());
        $('.draft').val('');
    });
});

</script>
</div>
</body>
</html>
